<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link rel="stylesheet" th:href="@{/css/mbti.css}">
  <link rel="stylesheet" th:href="@{/css/reset.css}">
  <link rel="stylesheet" th:href="@{/css/mypage/mypage-dark.css}">
</head>
<body>

<aside id="myPageAside">
  <img th:src="@{${userInfo.profileImage != null ? userInfo.profileImage : '/images/mypageimages/profile.png'}}" alt="í”„ë¡œí•„ ì‚¬ì§„" class="profile-photo" id="profilePhoto">
  <p id="nickname" class="nicknamefont">ë‹‰ë„¤ì„ : <span th:text="${myPageDTO.userName}"></span></p>
  <p id="rank" class="rankfont">ë“±ê¸‰: <span th:text="${userLevel}"></span></p>
  <p class="infofont" id="info">ê°œì¸ ì •ë³´</p>
  <p class="activefont" id="active">í™œë™ ê¸°ë¡</p>
  <p class="MBTIfont" id="mbtiButton">MBTI</p>
  <div id="mbtiContent" style="display: none;">
    <div id="myMBTI" class="mbti-item">
      -- ë‚˜ì˜ MBTI
    </div>
    <div class="mbti-item2" onclick="location.href='/mbti'">-- MBTI ê²€ì‚¬</div>
  </div>
  <form th:action="@{/auth/logout}" method="post">
    <button class="logoutFont" type="submit">ë¡œê·¸ì•„ì›ƒ</button>
  </form>
</aside>
<div class="rankpopup" id="rank-popup">
  <p class="scorefont">ì¶œì„ íšŸìˆ˜ : <span th:text="${attendanceCount}"></span></p>
  <p class="nextfont">ë‹¤ìŒ ë“±ê¸‰ : <span th:text="${nextLevelName}"></span></p>
  <p class="needfont">í•„ìš” ì¶œì„ : <span th:text="${nextLevelRequiredAttendance}"></span></p>
</div>

<div class="modal-background" id="modal-background">
  <div class="pwdpopup" id="pwd-popup">
    <p class="pwdfont">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ë³¸ì¸ì„ì„ í™•ì¸í•´ ì£¼ì„¸ìš”!</p>
    <div class="pwd-container">
      <span class="pwdfont2">ë¹„ë°€ë²ˆí˜¸</span> <input type="password" id="pwdInput" placeholder="ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ì 8~12ìë¦¬">
      <span class="toggle-password" id="togglePassword"><img id="passwordIcon" src="/images/icon/closeEye.png" alt="eye-icon" /></span>
    </div>

    <div class="popup-buttons">
      <button id="closePopupBtn" class="cancle-btn">ì·¨ì†Œ</button>
      <button id="submitPasswordBtn" class="confirm-btn">í™•ì¸</button>
    </div>

  </div>
</div>
<div class="mbtipopup" id="mbtiPopup">
  <p class="horrormbti">ë‚˜ì˜ ê³µí¬ MBTI</p>
  <p class="mbticategory" th:text="${mbtiInfo.MBTI_TYPE}"></p>
  <div class="mbtiexp">
    <p class="mtbtiexp2" th:text="${mbtiInfo.MBTI_INFO}"></p>
  </div>
</div>
<div class="resolution">
  <img class="background" th:src="@{/images/mbti/testBackground.png}" alt="mbti í…ŒìŠ¤íŠ¸ ë°°ê²½">

  <div id="loadingbarMain">
    <div id="loadingbar"></div>
  </div>

  <nav>
    <!--ë„¤ë¹„ë°”-->
    <img th:src="@{/images/main/nav-logo-dark.png}" alt="ìƒë‹¨ ë¡œê³ " onclick="location.href='/'">
    <span onclick="location.href='/intro'">ì†Œê°œ</span>
    <span onclick="location.href='/notice'">ê³µì§€ì‚¬í•­</span>
    <span onclick="location.href='/post'">ê²Œì‹œíŒ</span>
    <span onclick="location.href='/mbti'">MBTI ê²€ì‚¬</span>
    <span id="mypageBtn">ë§ˆì´í˜ì´ì§€</span>
    <form th:action="@{/auth/logout}" method="post">
      <button id="logoutNav" type="submit">ë¡œê·¸ì•„ì›ƒ</button>
    </form>
    <span onclick="location.href='/auth/signupterms'">íšŒì›ê°€ì…</span>
  </nav>
  <img id="testBack" th:src="@{/images/mbti/testBackground.png}" alt="test ì‹œì‘ ì „ ë°°ê²½">

  <img id="question-img" src="/images/mbti/img.png" alt="MBTI Image" />
  <p id="question-text" th:text="${QuestionDTO != null ? QuestionDTO.text : 'ğŸ˜‚'}"></p>

  <img class="hands" th:src="@{/images/mbti/hands.png}" alt="ì†">
  <form th:action="@{/mbti/submitMbtiResult}" method="post">
  <button class="next" type="button" id="yes" onclick="answerQuestion('yes')" data-content="ì˜ˆ">ì˜ˆ</button>
  <button class="next" type="button" id="no" onclick="answerQuestion('no')" data-content="ì•„ë‹ˆì˜¤">ì•„ë‹ˆì˜¤</button>
  </form>
</div>
</body>

<script>
  // JavaScriptë¡œ í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€
  const mypageBtn = document.getElementById("mypageBtn");
  const myPageAside = document.getElementById("myPageAside");

  // ë²„íŠ¼ í´ë¦­ ì‹œ aside ì°½ í‘œì‹œ/ìˆ¨ê¹€ ì „í™˜
  mypageBtn.addEventListener("click", () => {
    if (myPageAside.classList.contains("show")) {
      // ë³´ì´ëŠ” ìƒíƒœë¼ë©´ ìˆ¨ê¸°ê¸°
      myPageAside.classList.remove("show");
      setTimeout(() => {
        myPageAside.style.display = "none"; // ì• ë‹ˆë©”ì´ì…˜ í›„ displayë¥¼ noneìœ¼ë¡œ
      }, 400); // transitionê³¼ ë™ì¼í•œ ì‹œê°„ ì„¤ì •
    } else {
      // ìˆ¨ê²¨ì§„ ìƒíƒœë¼ë©´ ë³´ì´ê²Œ í•˜ê¸°
      myPageAside.style.display = "block"; // ë¨¼ì € displayë¥¼ blockìœ¼ë¡œ ì„¤ì •
      setTimeout(() => {
        myPageAside.classList.add("show");
      }, 10); // ì•½ê°„ì˜ ì§€ì—° ì‹œê°„ í›„ì— show í´ë˜ìŠ¤ ì¶”ê°€
    }
  });

  const gradeElement = document.getElementById('rank');
  const popup = document.getElementById('rank-popup');

  gradeElement.addEventListener('mouseenter', () => {
    popup.style.display = 'block'; // íŒì—… í‘œì‹œ
  });

  gradeElement.addEventListener('mouseleave', () => {
    popup.style.display = 'none'; // íŒì—… ìˆ¨ê¸°ê¸°
  });

  const personalInfoBtn = document.getElementById('info');
  const passwordPopup = document.getElementById('pwd-popup');
  const closePopupBtn = document.getElementById('closePopupBtn');
  const togglePassword = document.getElementById('togglePassword');
  const passwordInput = document.getElementById('pwdInput');
  const submitPasswordBtn = document.getElementById('submitPasswordBtn');
  const modal = document.querySelector('.modal-background');
  const passwordIcon = document.getElementById('passwordIcon');

  //ëª¨ë‹¬
  personalInfoBtn.addEventListener('click', () => {
    passwordPopup.style.display = 'block';// ë¹„ë°€ë²ˆí˜¸ íŒì—… í‘œì‹œ
    document.body.style.overflow = "hidden"; // ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
  });

  personalInfoBtn.addEventListener("click", () => {
    modal.style.display = "flex";
    if (modal.style.display === "flex") {
      closePopupBtn.addEventListener("click", () => {
        modal.style.display = "none";
        document.body.style.overflow = "auto"; // ìŠ¤í¬ë¡¤ ë‹¤ì‹œ í™œì„±í™”
      });
    }
  });


  // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
  togglePassword.addEventListener('click', () => {
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    passwordIcon.src = type === 'password' ? '/images/icon/closeEye.png' : '/images/icon/openEye.png';
  });


  submitPasswordBtn.addEventListener('click', () => {
    const inputPassword = passwordInput.value;

    // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ìš”ì²­
    fetch('/verifyPassword', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({ inputPassword })
    })
            .then(response => response.json())
            .then(isPasswordCorrect => {
              if (isPasswordCorrect) {
                // ë¹„ë°€ë²ˆí˜¸ê°€ ë§ìœ¼ë©´ ê°œì¸ì •ë³´ í˜ì´ì§€ë¡œ ì´ë™
                location.href = '/userinfo';
              } else {
                // ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦¬ë©´ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              }
            })
            .catch(error => {
              console.error('ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ìš”ì²­ ì‹¤íŒ¨:', error);
              alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
  });

  const activebtn = document.getElementById('active');
  activebtn.addEventListener('click', () => {
    // URLì„ ì›í•˜ëŠ” ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš”
    location.href = '/useractive';
  });

  const mbtiButton = document.getElementById("mbtiButton");
  const mbtiContent = document.getElementById("mbtiContent");
  const myMBTI = document.getElementById("myMBTI");
  const mbtiPopup = document.getElementById("mbtiPopup");

  // MBTI ë²„íŠ¼ í´ë¦­ ì‹œ MBTI ì½˜í…ì¸  í‘œì‹œ
  mbtiButton.addEventListener("click", () => {
    // ì½˜í…ì¸  í‘œì‹œ ìƒíƒœë¥¼ í† ê¸€
    mbtiContent.style.display = mbtiContent.style.display === "none" ? "block" : "none";
  });

  // ë‚˜ì˜ MBTI ìš”ì†Œì— ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ íŒì—… í‘œì‹œ
  myMBTI.addEventListener("mouseenter", () => {
    mbtiPopup.style.display = "block";
  });

  // ë‚˜ì˜ MBTI ìš”ì†Œì—ì„œ ë§ˆìš°ìŠ¤ ë‚˜ê°”ì„ ë•Œ íŒì—… ìˆ¨ê¸°ê¸°
  myMBTI.addEventListener("mouseleave", () => {
    mbtiPopup.style.display = "none";
  });
</script>
<script>
  class MbtiTesterDTO {
    constructor() {
      this.CB = 0;
      this.HG = 0;
      this.SE = 0;
      this.TM = 0;
    }

    updateMbti(questionNo, answer) {
      if (questionNo >= 1 && questionNo <= 9) {
        if (answer === "yes") {
          this.CB++;
        } else if (answer === "no") {
          this.CB--;
        }
      } else if (questionNo >= 10 && questionNo <= 18) {
        if (answer === "yes") {
          this.HG++;
        } else if (answer === "no") {
          this.HG--;
        }
      } else if (questionNo >= 19 && questionNo <= 27) {
        if (answer === "yes") {
          this.SE++;
        } else if (answer === "no") {
          this.SE--;
        }
      } else if (questionNo >= 28 && questionNo <= 36) {
        if (answer === "yes") {
          this.TM++;
        } else if (answer === "no") {
          this.TM--;
        }
      }
    }
    toString() {
      return `MbtiTester{CB=${this.CB}, HG=${this.HG}, SE=${this.SE}, TM=${this.TM}}`;
    }
  }

  function submitMbtiResult() {
    fetch('/mbti/submitmbtiresult', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        CB: mbtiTesterDTO.CB,
        HG: mbtiTesterDTO.HG,
        SE: mbtiTesterDTO.SE,
        TM: mbtiTesterDTO.TM
      })
    })
            .then(response => response.json())
            .then(data => {
              location.href = '/mbti/mbtiresult';
            })
            .catch(error => console.error('Error submitting MBTI result:', error));
  }
  const totalQuestions = 36; // ë³€í•˜ì§€ ì•Šì„ê±°ë‹ˆê¹Œ const
  let currentQuestionNo = 1; // ë³€í•´ì•¼ í•˜ë‹ˆê¹Œ let
  const mbtiTesterDTO = new MbtiTesterDTO(); // ê²°ê³¼ë‹´ì„ ê³µê°„

  function updateLoadingBar() {
    const progress = (currentQuestionNo - 1) / totalQuestions * 100;
    document.getElementById("loadingbar").style.width = progress + "%";
  }

  function answerQuestion(answer) {

    if (currentQuestionNo === 37) {
      submitMbtiResult();
      return;
    }

    updateLoadingBar();

    mbtiTesterDTO.updateMbti(currentQuestionNo, answer);
    const imagePath = `/images/mbti/questions/mbti${currentQuestionNo}img.png`;
    fetch(`/mbti/question/${currentQuestionNo}`)
            .then(response => response.json())
            .then(data => {
              document.getElementById("question-text").textContent = data.text;
              // document.getElementById("question-img").src = '/images/mbti/questions/' + data.image; // dbê²½ë¡œë¡œ í•˜ë ¤ê³ í–ˆëŠ”ë° ì•ˆë¼ì„œ ë°”ê¿ˆ - ì´ ì¤„ì€ dbë„£ì„ë•Œ ì‚¬ìš©
              document.getElementById("question-img").src = imagePath;
              currentQuestionNo++;
            })
            .catch(error => console.error('Error fetching data:', error));
    console.log(mbtiTesterDTO.toString());
  }
</script>
<script>
  function update(e){
    var x = e.clientX || e.touches[0].clientX
    var y = e.clientY || e.touches[0].clientY

    document.documentElement.style.setProperty('--cursorX', x + 'px')
    document.documentElement.style.setProperty('--cursorY', y + 'px')}

  document.addEventListener('mousemove',update)
  document.addEventListener('touchmove',update)
</script>
</html>