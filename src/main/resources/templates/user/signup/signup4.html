<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>회원 정보 입력</title>
    <link rel="stylesheet" th:href="@{/css/signup/signupMain.css}">
    <link rel="stylesheet" th:href="@{/css/reset.css}">
</head>
<body>
<div class="resolution">
    <img class="background01" th:src="@{/images/login/background01.png}" alt="배경">
    <img class="background02" th:src="@{/images/login/background02.png}" alt="배경">
    <nav>
        <!--네비바-->
        <img th:src="@{/images/main/nav-logo-dark.png}" alt="상단 로고" onclick="location.href='/'">
        <span onclick="location.href='/intro/intro'">소개</span>
        <span onclick="location.href='/notice/notice'">공지사항</span>
        <span>게시판</span>
        <span>MBTI 검사</span>
        <span>마이페이지</span>
        <span>로그인</span>
        <span>회원가입</span>
    </nav>
    <div class="uiBackSign"></div>
    <p class="signupInfoText">회원가입</p>
    <p class="signupGuideText">* 은 필수 입력 사항입니다.</p>
    <form th:action="@{/auth/signup}" method="post" id="confirm">
    <label for="id" class="idLabel">* 아이디 : </label><input type="text" id="id" class="idInput" name="userId" placeholder="영문, 숫자, 특수문자로 자유롭게 최대 7글자 입력해주세요." maxlength="7" minlength="4" oninput="toggleFields()" required><p id="idCheckMessage"></p>
    <label for="password" class="pwdLabel">* 비밀번호 : </label><input type="password" id="password" class="pwdInput" name="userPass" placeholder="영문, 숫자, 특수문자 조합 8 ~ 12자로 입력해주세요." maxlength="12" minlength="8" required><p id="pwdCheckMessage"></p>
    <label for="passwordConfirm" class="pwdConfirmLabel">* 비밀번호 확인 : </label><input type="password" id="passwordConfirm" class="pwdConfirmInput" name="passwordConfirm" placeholder="비밀번호와 동일하게 입력해주세요." maxlength="14" minlength="1" oninput="toggleNicknameField()" required><p id="pwdConfirmMessage"></p>
    <label for="nickname" class="nicknameLabel">* 닉네임 : </label><input type="text" id="nickname" name="userName" class="nicknameInput" placeholder="한글, 영문, 숫자, 특수문자 등 최대 7글자로 입력해주세요." maxlength="7" minlength="1" oninput="toggleEmailField()" required><p id="nicknameCheckMessage"></p>

    <label for="email" class="emailLabel">이메일 : </label><input type="text" id="email" class="emailInput" name="userEmail" minlength="1" oninput="toggleBirthField()" required>
    <p class="emailMain">@</p>
    <input class="box" id="domain-txt" type="text"/>
    <select class="box" id="domain-list">
        <option class="sopText" value="type">직접 입력</option>
        <option class="sop" value="naver.com">naver.com</option>
        <option class="sop" value="google.com">google.com</option>
        <option class="sop" value="daum.net">hanmail.net</option>
        <option class="sop" value="nate.com">nate.com</option>
        <option class="sop" value="kakao.com">kakao.com</option>
        </select>
    <button class="authEmail">인증</button>

    <!-- 인증 모달 -->
    <div class="modalBlur">
        <div class="modalGuide">
            <h1 style="color:white;">이메일 인증</h1>
            <label for="authNumber" class="authNumber">인증 번호 : </label><input id="authNumber" type="text" name="authNumber" placeholder="인증번호 입력" maxlength="6">
        </div>
    </div>

    <p class="birthday">생년월일 : </p>
    <div class="info" id="info_birth">
        <select class="box1" id="birth-year">
            <option disabled selected>출생 연도</option>
        </select>
        <select class="box1" id="birth-month">
            <option disabled selected>월</option>
        </select>
        <select class="box1" id="birth-day">
            <option disabled selected>일</option>
        </select>
    </div>
        <div class="error-msg"></div>
        <!--   select쪽이 input이 아니라 안담기는 것 같아서 생성    -->
        <input type="hidden" name="userBirth" id="birthDate">
    <button type="button" id="resetBirth">초기화</button>

    <label class="gender">성별 : </label><label for="man" class="man">남 </label><input type="radio" id="man" name="userGender" value="MALE" oninput="toggleBirthField()">
    <label for="woman" class="woman">여 </label><input type="radio" id="woman" name="userGender" value="FEMALE" oninput="toggleBirthField()">
    <label for="none" class="none">비밀</label><input type="radio" id="none" name="userGender" value="OTHER" oninput="toggleBirthField()" checked>

    <button id="next" type="submit" class="next">다음</button>
    </form>
</div>
<script>
    // 아이디 체크
    document.getElementById('id').addEventListener('input', function() {
        const nextButton = document.getElementById('next')
        const userIdInput = this;
        const userId = this.value;
        const messageElement = document.getElementById('idCheckMessage');
        const hasKorean = /[^a-zA-Z0-9-_]/.test(userId);
        if (hasKorean) {
            userIdInput.value = userId.replace(/[^a-zA-Z0-9-_]/g, '');
            messageElement.textContent = "사용할 수 없는 단어가 포함 돼 있습니다.";
            messageElement.style.color = "#FD3C3C";
            nextButton.disabled = true;
            return;
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
        }

        if (userId.length < 3 && userId.length > 0) {
            messageElement.textContent = "아이디는 최소 4자리 이상이어야 합니다.";
            messageElement.style.color = "#FD3C3C";
            nextButton.disabled = true;
            return;
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
        }

        if (userId.length > 3) {
            fetch(`/auth/checkId?userId=${ userId }`)
                .then(response => response.json())
                .then(isAvailable => {
                    if (isAvailable) {
                        messageElement.textContent = "사용 가능한 아이디입니다.";
                        messageElement.style.color = "#6EBA4A";
                        nextButton.disabled = false;
                    } else {
                        messageElement.textContent = "이미 사용 중인 아이디입니다.";
                        messageElement.style.color = "#FD3C3C";
                        nextButton.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageElement.textContent = "사용 불가한 아이디입니다.";
                    messageElement.style.color = "#FD3C3C";
                });
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
        }
    });

    // 비밀번호 체크
    document.getElementById('password').addEventListener('input', function() {
        const nextButton = document.getElementById('next')
        const userPwd = this.value;
        const messageElement = document.getElementById('pwdCheckMessage');
        const passwordConfirmInput = document.getElementById('passwordConfirm');
        const rule = /[^a-zA-Z0-9-_!@#$%^&*()+|{};':.,/?<>]/.test(userPwd);
        const kor = /[ㄱ-ㅎ가-힣]/.test(userPwd)

        if (rule || kor) {
            messageElement.textContent = "사용할 수 없는 단어가 포함 돼 있습니다.";
            messageElement.style.color = "#FD3C3C";
            nextButton.disabled = true;
            passwordConfirmInput.disabled = true;
            return;
        } else {
            messageElement.textContent = "";
        }

        if (userPwd.length < 8 && userPwd.length > 0) {
            messageElement.textContent = "비밀번호는 최소 8자리 이상이어야 합니다.";
            messageElement.style.color = "#FD3C3C";
            nextButton.disabled = true;
            passwordConfirmInput.disabled = true;
            return;
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
        }

        if (userPwd.length > 7) {
            fetch(`/auth/checkPassword?userPwd=${ encodeURIComponent(userPwd) }`) // 오른쪽이 GetMapping에서 RequestParam으로 불러올 공간
                .then(response => response.json())
                .then(isAvailable => {
                    if (isAvailable) {
                        messageElement.textContent = "사용 가능한 비밀번호입니다.";
                        messageElement.style.color = "#6EBA4A";
                        nextButton.disabled = false;
                        passwordConfirmInput.disabled = false;
                    } else {
                        messageElement.textContent = "사용 불가한 비밀번호입니다.";
                        messageElement.style.color = "#FD3C3C";
                        nextButton.disabled = true;
                        passwordConfirmInput.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageElement.textContent = "사용 불가한 비밀번호입니다.";
                    messageElement.style.color = "#FD3C3C";
                    nextButton.disabled = true;
                    passwordConfirmInput.disabled = true;
                });
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
        }
    });

    // 비밀번호 확인 체크
    document.getElementById('passwordConfirm').addEventListener('input', function() {
        const nextButton = document.getElementById('next');
        const userConfirmPwd = this.value;
        const userPwd = document.getElementById('password').value;
        const passwordInput = document.getElementById('password');
        const messageElement = document.getElementById('pwdConfirmMessage');

        if (userPwd.length === 0) {
            messageElement.textContent = "비밀번호를 먼저 입력하세요.";
            messageElement.style.color = "#FD3C3C";
            nextButton.disabled = true;
            passwordInput.disabled = false;
            return;
        }

        if (userPwd.length > 7) {
            // 위에서 value 안썼으면 안에서 써야함 -> value가 없어도 되기는 하는데 넣는게 좋다.
            fetch(`/auth/passwordConfirm?userPwd=${encodeURIComponent(userPwd)}&confirmPwd=${encodeURIComponent(userConfirmPwd)}`)
                .then(response => response.json())
                .then(isAvailable => {
                    if (isAvailable) {
                        messageElement.textContent = "동일한 비밀번호입니다.";
                        messageElement.style.color = "#6EBA4A";
                        nextButton.disabled = false;
                        passwordInput.disabled = true;
                    } else {
                        messageElement.textContent = "동일하지 않은 비밀번호입니다.";
                        messageElement.style.color = "#FD3C3C";
                        nextButton.disabled = true;
                        passwordInput.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageElement.textContent = "동일하지 않은 비밀번호입니다.";
                    messageElement.style.color = "#FD3C3C";
                    nextButton.disabled = true;
                    passwordInput.disabled = false;
                });
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
            passwordInput.disabled = false;
        }
    });

    // 닉네임 중복 테스트
    document.getElementById('nickname').addEventListener('input', function() {
        const nextButton = document.getElementById('next')
        const userNickInput = this;
        const userNick = this.value;
        const messageElement = document.getElementById('nicknameCheckMessage');
        const rules = /[^가-힣ㄱ-ㅎa-zA-Z0-9-_!@#$%^&*()+|{};':.,/?<>]/.test(userNick);
        if (rules) {
            userNickInput.value = userNick.replace(/[^가-힣ㄱ-ㅎa-zA-Z0-9-_!@#$%^&*()+|{};':.,/?<>]/g, '');
            messageElement.textContent = "사용할 수 없는 단어가 포함 돼 있습니다.";
            messageElement.style.color = "#FD3C3C";
            nextButton.disabled = true;
            return;
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
        }

        if (userNick.length > 0) {
            fetch(`/auth/checkNick?userNick=${ userNick }`)
                .then(response => response.json())
                .then(isAvailable => {
                    if (isAvailable) {
                        messageElement.textContent = "사용 가능한 닉네임입니다.";
                        messageElement.style.color = "#6EBA4A";
                        nextButton.disabled = false;
                    } else {
                        messageElement.textContent = "이미 사용 중인 닉네임입니다.";
                        messageElement.style.color = "#FD3C3C";
                        nextButton.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageElement.textContent = "사용 불가한 닉네임입니다.";
                    messageElement.style.color = "#FD3C3C";
                });
        } else {
            messageElement.textContent = "";
            nextButton.disabled = true;
        }
    });


    // 이메일 부분 로직
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        const emailInput = document.querySelector('#email');
        const domainInput = document.querySelector('#domain-txt');
        const domainSelect = document.querySelector('#domain-list');

        const frontEmail = emailInput.value.split('@')[0];
        emailInput.value = frontEmail;

        if (domainSelect.value !== "type") {
            emailInput.value += "@" + domainSelect.value;
        } else {
            emailInput.value += "@" + domainInput.value;
        }
    });

    form.addEventListener('submit', function(event) {
        const year = document.querySelector('#birth-year').value;
        const month = document.querySelector('#birth-month').value;
        const day = document.querySelector('#birth-day').value;

        if (year && month && day) {
            // DATE 객체에서 month는 1로 선택해도 0으로 인식되어 -1이 들어가야함 // 일에서도 문제가 생기는데 일 부분에서 수정해서 정상적으로 됨 // 이상하게 다른것도 다같이 해결됐다. 일석이조
            const birthDate = new Date(year, month -1, day);
            const formattedDate = birthDate.toISOString().split('T')[0]; // 자료형이 DATE라서 STRING으로 변경 split T를 통해 24-11-04 이런식으로 저장
            document.querySelector('#birthDate').value = formattedDate;
        }
    });

    form.addEventListener('submit', function(event) {
        const genderInput = document.querySelector('input[name="gender"]:checked');
        const formattedGender = genderInput ? genderInput.value : null;
    });


    // 회원가입 메시지 => 나중에 모달로 변경하면 좋을듯?
        const message = `[[${ message }]]`
        if(message) {
        alert(message);
    }

    // 이메일
    const domainListEl = document.querySelector('#domain-list')
    const domainInputEl = document.querySelector('#domain-txt')
    domainListEl.addEventListener('change', (event) => {
        if(event.target.value !== "type") {
            domainInputEl.value = event.target.value
            domainInputEl.disabled = true
        } else {
            domainInputEl.value = ""
            domainInputEl.disabled = false
        }
    })

    // 연
    const birthYearEl = document.querySelector('#birth-year')
    isYearOptionExisted = false;
    birthYearEl.addEventListener('focus', function () {
        if(!isYearOptionExisted) {
            isYearOptionExisted = true
            for(var i = 1940; i <= 2024; i++) {
                const YearOption = document.createElement('option')
                YearOption.setAttribute('value', i)
                YearOption.innerText = i
                this.appendChild(YearOption);
            }
        }
    });

    // 월
    const birthMonthEl = document.querySelector('#birth-month')
    isMonthOptionExisted = false;
    birthMonthEl.addEventListener('focus', function () {
        if(!isMonthOptionExisted) {
            isMonthOptionExisted = true
            for(var i = 1; i <= 12; i++) {
                const MonthOption = document.createElement('option')
                MonthOption.setAttribute('value', i)
                MonthOption.innerText = i
                this.appendChild(MonthOption);
            }
        }
    });

    // 일
    const birthDayEl = document.querySelector('#birth-day')
    isDayOptionExisted = false;
    birthDayEl.addEventListener('focus', function () {
        if(!isDayOptionExisted) {
            isDayOptionExisted = true
            for(var i = 0; i <= 31; i++) {
                const DayOption = document.createElement('option')
                DayOption.setAttribute('value', i + 1)
                DayOption.innerText = i
                this.appendChild(DayOption);
            }
        }
    });

    // 리셋버튼
    const resetAllButton = document.querySelector('#resetBirth');
    resetAllButton.addEventListener('click', function () {
        isYearOptionExisted = false;
        isMonthOptionExisted = false;
        isDayOptionExisted = false;

        birthYearEl.innerHTML = '<option value="year">출생 연도</option>';
        birthMonthEl.innerHTML = '<option value="month">월</option>';
        birthDayEl.innerHTML = '<option value="day">일</option>';
    });

    // 모달
    const modal = document.querySelector('.modalBlur');
    const btnOpenModal=document.querySelector('.authEmail');
    const btnCloseModal=document.querySelector('.modalBlur');

    btnOpenModal.addEventListener("click", ()=>{
        newButton.style.display = "block";
    })

    btnOpenModal.addEventListener("click", ()=>{
        modal.style.display="flex";
        if (modal.style.display === "flex") {
            // 인증번호 맞으면 되는거로 바꿀것 // else는 값이 틀렸다고 알려주고 x로 나갈 수 있게함
            btnCloseModal.addEventListener("click", () => {
                modal.style.display = "none";
            });
        }
    });

    // 입력한다음 넘어가기
    const userIdInput = document.getElementById('id');
    const passwordInput = document.getElementById('password');
    const passwordConfirmInput = document.getElementById('passwordConfirm');
    const nicknameInput = document.getElementById('nickname');
    const emailInput = document.getElementById('email');
    const emailDomainInput = document.getElementById('domain-txt');
    const emailSelectInput = document.getElementById('domain-list');
    const birthYear = document.getElementById('birth-year');
    const birthMonth = document.getElementById('birth-month');
    const birthDay = document.getElementById('birth-day');
    const man = document.getElementById('man');
    const woman = document.getElementById('woman');
    const other = document.getElementById('none');

    // id는 처음에 활성화 돼 있어야 하므로 없어야 함
    passwordInput.disabled = true;
    passwordConfirmInput.disabled = true;
    nicknameInput.disabled = true;
    emailInput.disabled = true;
    emailDomainInput.disabled = true;
    emailSelectInput.disabled = true;
    birthYear.disabled = true;
    birthMonth.disabled = true;
    birthDay.disabled = true;
    man.disabled = true;
    woman.disabled = true;
    other.disabled = true;

    function toggleFields() {
        if (userIdInput.value) {
            passwordInput.disabled = false;
        } else {
            resetFields();
        }
    }

    function toggleNicknameField() {
        if (passwordConfirmInput.value) {
            nicknameInput.disabled = false;
        } else {
            nicknameInput.disabled = true;
            emailInput.disabled = true;
        }
        toggleEmailField();
    }

    function toggleEmailField() {
        if (nicknameInput.value) {
            emailInput.disabled = false;
            emailDomainInput.disabled = false;
            emailSelectInput.disabled = false;
        } else {
            emailInput.disabled = true;
            emailDomainInput.disabled = true;
            emailSelectInput.disabled = true;
        }
    }

    function toggleBirthField() {
        if (emailInput.value) {
            birthYear.disabled = false;
            birthMonth.disabled = false;
            birthDay.disabled = false;
            man.disabled = false;
            woman.disabled = false;
            other.disabled = false;
        } else {
            birthYear.disabled = true;
            birthMonth.disabled = true;
            birthDay.disabled = true;
            man.disabled = true;
            woman.disabled = true;
            other.disabled = true;
        }
    }

    function resetFields() {
        passwordInput.disabled = true;
        passwordConfirmInput.disabled = true;
        nicknameInput.disabled = true;
        emailInput.disabled = true;
        emailDomainInput.disabled = true;
        emailSelectInput.disabled = true;
        birthYear.disabled = true;
        birthMonth.disabled = true;
        birthDay.disabled = true;
        man.disabled = true;
        woman.disabled = true;
        other.disabled = true;
        passwordInput.value = "";
        passwordConfirmInput.value = "";
    }

    // 이거 사용하지 않고 body쪽에서 oninput 사용
    // userIdInput.addEventListener('input', toggleFields);
    // passwordInput.addEventListener('input', togglePasswordConfirmField);
    // passwordConfirmInput.addEventListener('input', toggleNicknameField);
    // nicknameInput.addEventListener('input', toggleEmailField);
</script>
</body>
</html>