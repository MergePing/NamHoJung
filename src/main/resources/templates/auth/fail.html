<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>로그인 실패 화면(상자 안열린 상태) - 필요없을 수 있는 부분</title>
    <link rel="stylesheet" th:href="@{/css/login.css}" />
    <link rel="stylesheet" th:href="@{/css/reset.css}" />
</head>
<body>
<div class="resolution">
    <div class="backgroundBasic"></div>
    <img class="background01" th:src="@{/images/login/background01.png}" alt="배경">
    <img class="background02" th:src="@{/images/login/background02.png}" alt="배경">
    <nav>
        <!--네비바-->
        <img th:src="@{/images/main/nav-logo-dark.png}" alt="상단 로고" onclick="location.href='/'">
        <span onclick="location.href='/intro'">소개</span>
        <span onclick="location.href='/notice'">공지사항</span>
        <span onclick="location.href='/post'">게시판</span>
        <span onclick="location.href='/mbti'">MBTI 검사</span>
        <span id="mypageBtn">마이페이지</span>
        <span onclick="location.href='/auth/login'">로그인</span>
        <span onclick="location.href='/auth/signupterms'">회원가입</span>
    </nav>

        <div class="loginDiv" ></div>
        <img th:src="@{/images/login/login.png}" id="backLogin">
        <p class="loginText">로그인</p>
        <p class="loginGuide">회원가입 시 입력한 아이디와 비밀번호를 입력해주세요.</p>
        <button type="submit">
            <img class="loginBox" th:src="@{/images/login/loginBox.png}" alt="로그인박스">
        </button>
        <p class="search" onclick="location.href='/find/select'">ID / 비밀번호 찾기</p>
        <label class="id" for="inputId">아이디 : </label><input class="idDiv" type="text" id="inputId" name="userId" placeholder="아이디를 입력해주세요.">
        <label class="pwd" for="inputPwd">비밀번호 : </label><input class="pwdDiv" type="password" id="inputPwd" name="userPass" placeholder="비밀번호를 입력해주세요.">
        <span id="togglePassword" class="toggle-eye"><img src="/images/icon/closeEye.png" alt="비밀번호 보기" id="togglePasswordIcon"></span>
        <input id="saveId" class="saveId" type="checkbox" name="id" value="id">
        <label for="saveId" class="saveIdLabel">아이디 저장</label>
    </form>
    <p class="warning">아이디와 비밀번호가 올바르지 않습니다.</p>

    <img th:src="@{/images/login/searchButton.png}" id="findButton">
</div>
<script>
    // 비밀번호 눈모양
    function togglePasswordVisibility(id) {
        const passwordField = document.getElementById(id);
        const icon = document.getElementById('togglePasswordIcon');

        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.src = '/images/icon/openEye.png';
        } else {
            passwordField.type = 'password';
            icon.src = '/images/icon/closeEye.png';
        }
    }

    document.getElementById('togglePassword').addEventListener('click', function() {
        togglePasswordVisibility('inputPwd');
    });

    // 아이디 저장
    window.onload = function() {
        const savedId = localStorage.getItem('savedUserId');
        if (savedId) {
            document.getElementById('inputId').value = savedId;
            document.getElementById('saveId').checked = true;
        }
    }

    document.querySelector('form').onsubmit = function() {
        const userId = document.getElementById('inputId').value;
        const saveId = document.getElementById('saveId').checked;

        if (saveId) {
            localStorage.setItem('savedUserId', userId);
        } else {
            localStorage.removeItem('savedUserId');
        }
    };

    // 새롭게 비동기로 구현
    document.getElementById('loginForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const userId = document.getElementById('inputId').value;
        const userPass = document.getElementById('inputPwd').value;

        const saveId = document.getElementById('saveId').checked;
        if (saveId) {
            localStorage.setItem('savedUserId', userId);
        } else {
            localStorage.removeItem('savedUserId');
        }

        // 로그인 실패 횟수 추적
        let failCount = parseInt(localStorage.getItem('loginFailCount')) || 0;

        fetch('/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId: userId, userPass: userPass })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 로그인 성공 시
                    localStorage.removeItem('loginFailCount');  // 실패 횟수 초기화
                    window.location.href = '/';  // 메인 페이지로 이동
                } else {
                    // 로그인 실패 시
                    failCount++;  // 실패 횟수 증가
                    localStorage.setItem('loginFailCount', failCount);

                    // 실패 횟수에 따라 이미지 변경
                    changeBoxImage(failCount);
                    alert('아이디 또는 비밀번호가 잘못되었습니다.');
                }
            })
            .catch(error => {
                console.error('Error during login:', error);
                alert('로그인 처리 중 오류가 발생했습니다. 다시 시도해주세요.');
            });
    });

    // 로그인 실패 횟수에 따라 상자 이미지 변경
    function changeBoxImage(failCount) {
        const boxImage = document.getElementById('backLogin');
        if (failCount === 1) {
            boxImage.src = 'images/login/loginbox2';  // 첫 번째 실패 이미지
        } else if (failCount === 2) {
            boxImage.src = 'images/login/loginbox3';  // 두 번째 실패 이미지
        } else if (failCount >= 3) {
            boxImage.src = 'images/login/loginbox4';  // 세 번째 실패 이미지
        }
    }

    // 로그인 시 상자 이미지 초기화
    window.onload = function() {
        const failCount = parseInt(localStorage.getItem('loginFailCount')) || 0;
        changeBoxImage(failCount);  // 페이지 로드 시 실패 횟수에 따른 이미지 변경
    };

</script>
</body>
</html>