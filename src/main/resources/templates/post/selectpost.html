<!DOCTYPE html>
<HTML LANG="EN">
<head>
    <meta charset="UTF-8">
    <title>게시판</title>
    <link rel="stylesheet" th:href="@{/css/reset.css}">
    <link rel="stylesheet" th:href="@{/css/post/selectpost.css}">
    <style>
        /*손전등*/
        /*:root {*/
        /*    --cursorX: 70vw;*/
        /*    --cursorY: 70vh;*/
        /*}*/
        /*:root:before {*/
        /*    content: '';*/
        /*    display: block;*/
        /*    width: 100%;*/
        /*    height: 100%;*/
        /*    position: fixed;*/
        /*    pointer-events: none;*/
        /*    z-index: 999999;*/
        /*    background: radial-gradient(*/
        /*            circle 15vmax at var(--cursorX) var(--cursorY),*/
        /*            rgba(0,0,0,0) 0%,*/
        /*            rgba(0,0,0,.5) 80%,*/
        /*            rgba(0,0,0,.95) 100%)*/
        /*}*/

        /** {*/
        /*    box-sizing: border-box;*/
        /*    text-rendering: optimizeLegibility;*/
        /*    -webkit-font-smoothing: antialiased;*/
        /*    -moz-osx-font-smoothing: grayscale;*/
        /*    font-kerning: auto;*/
        /*}*/

        .ellipsis {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .blur{
            filter: blur(7.5px);
        }
    </style>
</head>
<body data-user-id="${user.id}">
<header>
    <nav>
        <!-- 네비바 -->
        <img th:src="@{/images/notice/nav-logo-dark.png}" alt="상단 로고" onclick="window.location.href='/'">
        <span onclick="location.href='/intro'">소개</span>
        <span onclick="location.href='/notice'">공지사항</span>
        <span onclick="location.href='/post'">게시판</span>
        <span>MBTI 검사</span>
        <span>마이페이지</span>
        <span>로그인</span>
        <span>회원가입</span>
    </nav>
</header>
<main>
    <div class="post">
        <div id="header">
            <span>
                <img th:src="@{/images/post/best-dark.png}" th:if="${post.postFavorite}" th:attr="data-postNo=${post.postNo}"
                     class="favorite-icon" onclick="toggleFavorite(this)">
                <img th:src="@{/images/post/best-none-dark.png}" th:unless="${post.postFavorite}" th:attr="data-postNo=${post.postNo}"
                     class="favorite-icon" onclick="toggleFavorite(this)">
            </span>
            <span th:text="${post.postNo}" id="no"></span>
            <span th:text="${post.postTitle}" id="title"></span>
            <script>
                window.addEventListener('load', () => {
                    const title = document.getElementById("title");
                    const no = document.getElementById("no");

                    const checkTitleWidth = () => {
                        const titleWidth = title.offsetWidth;
                        if (titleWidth > 1000) {
                            title.style.fontSize = '35px';
                            title.style.marginTop='15px';
                            no.style.marginTop='15px';
                            title.style.marginLeft='130px';
                            no.style.fontSize = '35px';
                        } else {
                            title.style.fontSize = ''; // 기본 폰트 크기로 되돌림
                        }
                    };

                    // 페이지 로드 시 및 윈도우 리사이즈 시 폰트 크기 체크
                    checkTitleWidth();
                    window.addEventListener('resize', checkTitleWidth);
                });

            </script>
            <span>작성날짜 : </span>
            <span th:text="${post.postDate}"></span>
            <div th:if="${userInfo.userName} != ${post.postWriterName}">
                <img th:src="@{/images/post/selectpost/reportbtn.png}">
                <span>신고</span>
            </div>
        </div>
        <div class="line"></div>
        <div id="content">
            <span th:text="${post.postContent}"></span>

            <!-- 이미지 경로 설정 -->
            <img class="blur" id="img1" th:data-src="@{${post.postImageFirst}}" alt="첫 번째 이미지">
            <img class="blur" id="img2" th:data-src="@{${post.postImageSecond}}" alt="두 번째 이미지">


        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const img1 = document.getElementById('img1');
                const img2 = document.getElementById('img2');

                if (img1 && img1.dataset.src) {
                    img1.src = img1.dataset.src + `?t=${new Date().getTime()}`;
                }

                if (img2 && img2.dataset.src) {
                    img2.src = img2.dataset.src + `?t=${new Date().getTime()}`;
                }
            });
        </script>


        <script>

            const img1 = document.getElementById("img1");
            const img2 = document.getElementById("img2");

            if (img1 !== null) {
                img1.addEventListener('click', () => {
                    img1.classList.toggle("blur");
                });
            }

            if (img2 !== null) {
                img2.addEventListener('click', () => {
                    img2.classList.toggle("blur");
                });
            }
        </script>

        <div id="box">
            <div id="writer" class="post-user">

                <div th:if="${userInfo.userName} == ${post.postWriterName}">
                    <img th:src="@{${userInfo.profileImage != null ? userInfo.profileImage : '/images/mypageimages/profile.png'}}"
                         alt="프로필 사진" class="profile-photo" id="profilePhoto">
                </div>
                <div th:if="${userInfo.userName} != ${post.postWriterName}">
                    <img th:src="@{${post.profileImage != null ? post.profileImage : '/images/mypageimages/profile.png'}}"
                         alt="프로필 사진" class="profile-photo" id="profilePhoto1">
                </div>

                <span th:text="${userInfo.level}"></span>
                <span th:text="${post.postWriterName}"></span>
                <span> <img th:src="@{/images/post/selectpost/badge.png}">
            </span> <div> <span th:text="${post.postCategory}"></span>
            </div>
            </div>
            <div id="scary">
                <img th:src="@{/images/post/selectpost/scary-btn-before.png}" th:if="${!post.scary}"
                     th:attr="data-postNo=${post.postNo}"
                     class="scary-icon" onclick="toggleScary(this)">
                <img th:src="@{/images/post/selectpost/scary-btn-after.png}" th:if="${post.scary}"
                     th:attr="data-postNo=${post.postNo}"
                     class="scary-icon" onclick="toggleScary(this)">
                <div>
                    <span>무서워요</span>
                </div>
                <span th:text="${post.scaryNumber}"></span>
            </div>

            <div id="notscary">
                <img th:src="@{/images/post/selectpost/not-scary-btn-before.png}" th:if="${!post.notScary}"
                     th:attr="data-postNo=${post.postNo}"
                     class="notscary-icon" onclick="toggleNotScary(this)">
                <img th:src="@{/images/post/selectpost/not-scary-btn-after.png}" th:if="${post.notScary}"
                     th:attr="data-postNo=${post.postNo}"
                     class="notscary-icon" onclick="toggleNotScary(this)">
                <div>
                    <span>안무서워요</span>
                </div>
                <span th:text="${post.notScaryNumber}"></span>
            </div>



            <div class="line2"></div>

            <!-- 댓글 작성 영역 -->
            <div id="comment-section">
                <input type="text" id="comment-input" placeholder="댓글을 입력하세요..." />
                <button onclick="submitComment()">댓글 작성</button>
            </div>

            <!-- 댓글 목록 -->
            <div id="comments-list" style="display: none;">
                <div th:each="comment : ${comments}">
                    <div class="comment">
                        <img th:src="@{/images/post/selectpost/profile-img.png}">
                        <span th:text="${comment.username}"></span>
                        <span th:text="${comment.userLevel}"></span>
                        <span th:text="${comment.commentContent}"></span>
                        <span th:text="${comment.commentDate}"></span>
                        <img th:src="@{/images/post/selectpost/like-btn-before.png}">
                        <span>좋아요</span>

                        <div th:if="${comment.userNo} != ${userNo}">
                            <img th:src="@{/images/post/selectpost/reportbtn.png}">
                            <span>신고</span>
                        </div>

                        <!-- 삭제 버튼: 로그인한 유저와 댓글 작성자가 같을 때만 보이도록 설정 -->
                        <button class="delete-comment-btn"
                                th:data-comment-no="${comment.commentNo}"
                                th:if="${comment.userNo == userNo}">
                            삭제
                        </button>

                        <!-- 수정 버튼: 로그인한 유저와 댓글 작성자가 같을 때만 보이도록 설정 -->
                        <button class="edit-comment-btn"
                                th:data-comment-no="${comment.commentNo}"
                                th:if="${comment.userNo == userNo}">
                            수정
                        </button>

                    </div>
                </div>
            </div>

            <!-- 댓글 더보기 버튼 -->
            <div class="show-more-comments">
                <span onclick="loadComments()">댓글 보기</span>
            </div>
        </div>
    </div>
    <div class="bg"></div>

    <div th:if="${userInfo.userName} == ${post.postWriterName}">
        <button type="button" onclick="editPost()" id="editBtn">수정</button>
        <button type="button" id="deleteBtn" th:data-post-no="${post.postNo}">삭제</button>
    </div>
</main>
<footer>
    <div class="footer">
        <p>ⓒ 2024 MergePing. All right reserved. </p>
    </div>
</footer>

<script>
    function editPost(postNo) {
        // 게시글 수정 모달 창 열기
        // 여기에 모달 창을 여는 코드를 추가합니다.
        const modal = document.getElementById('editPostModal');
        modal.style.display = 'block';

        // 필요한 경우, 기존 게시글 내용을 모달 폼에 채워줍니다.
        // 예: document.getElementById('modalPostTitle').value = 기존 게시글 제목;
    }

    function closeModal() {
        // 모달 창 닫기
        const modal = document.getElementById('editPostModal');
        modal.style.display = 'none';
    }

    function deletePost(postNo) {
        if (confirm("정말 이 게시물을 삭제하시겠습니까?")) {
            fetch(`/post/${postNo}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("네트워크 응답이 실패했습니다.");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message || "게시물이 삭제되었습니다.");
                        window.location.href = "/post"; // 게시물 목록 페이지로 이동
                    } else {
                        alert(data.error || "게시물 삭제에 실패했습니다.");
                    }
                })
                .catch(error => console.error("Error:", error));
        }
    }

    // 삭제 버튼 클릭 이벤트 설정
    document.getElementById("deleteBtn").addEventListener("click", function () {
        const postNo = document.getElementById("deleteBtn").getAttribute("data-post-no");
        deletePost(postNo);
    });
</script>




<!--&lt;!&ndash; 모달 창 &ndash;&gt;-->
<!--<div id="editModal" class="modal">-->
<!--    <div class="modal-content">-->
<!--        <span class="close" onclick="closeEditModal()">&times;</span>-->
<!--        <h2>게시글 수정</h2>-->
<!--        <form id="editForm">-->
<!--            <input type="hidden" id="editPostNo" name="postNo">-->
<!--            <label for="editPostTitle">제목</label>-->
<!--            <input type="text" id="editPostTitle" name="postTitle" required>-->
<!--            <label for="editPostContent">내용</label>-->
<!--            <textarea id="editPostContent" name="postContent" required></textarea>-->
<!--            <button type="submit">수정</button>-->
<!--        </form>-->
<!--    </div>-->
<!--</div>-->

<!--<script>-->
<!--    function showEditModal(postNo) {-->
<!--        document.getElementById('editPostNo').value = postNo;-->
<!--        // 모달 창 열기-->
<!--        document.getElementById('editModal').style.display = 'block';-->
<!--    }-->

<!--    function closeEditModal() {-->
<!--        // 모달 창 닫기-->
<!--        document.getElementById('editModal').style.display = 'none';-->
<!--    }-->

<!--    function deletePost(postNo) {-->
<!--        if (confirm("정말 삭제하시겠습니까?")) {-->
<!--            fetch(`/deletepost/${postNo}`, {-->
<!--                method: 'DELETE'-->
<!--            })-->
<!--                .then(response => {-->
<!--                    if (response.ok) {-->
<!--                        alert("게시글이 삭제되었습니다.");-->
<!--                        window.location.href = '/posts'; // 게시글 목록 페이지로 이동-->
<!--                    } else {-->
<!--                        alert("삭제에 실패했습니다.");-->
<!--                    }-->
<!--                })-->
<!--                .catch(error => {-->
<!--                    console.error('Error deleting post:', error);-->
<!--                    alert("삭제에 실패했습니다.");-->
<!--                });-->
<!--        }-->
<!--    }-->

<!--    // 수정 폼 제출-->
<!--    document.getElementById('editForm').addEventListener('submit', function(event) {-->
<!--        event.preventDefault();-->
<!--        const postNo = document.getElementById('editPostNo').value;-->
<!--        const postTitle = document.getElementById('editPostTitle').value;-->
<!--        const postContent = document.getElementById('editPostContent').value;-->

<!--        fetch(`/editpost/${postNo}`, {-->
<!--            method: 'POST',-->
<!--            headers: {-->
<!--                'Content-Type': 'application/json'-->
<!--            },-->
<!--            body: JSON.stringify({postTitle: postTitle, postContent: postContent})-->
<!--        })-->
<!--            .then(response => {-->
<!--                if (response.ok) {-->
<!--                    alert("게시글이 수정되었습니다.");-->
<!--                    closeEditModal();-->
<!--                    window.location.reload(); // 페이지 새로고침-->
<!--                } else {-->
<!--                    alert("수정에 실패했습니다.");-->
<!--                }-->
<!--            })-->
<!--            .catch(error => {-->
<!--                console.error('Error editing post:', error);-->
<!--                alert("수정에 실패했습니다.");-->
<!--            });-->
<!--    });-->
<!--</script>-->



<script>
    function submitComment() {
        const commentInput = document.getElementById("comment-input");
        const commentContent = commentInput.value.trim();

        if (!commentContent) {
            alert("댓글 내용을 입력해주세요.");
            return;
        }

        const postNo = document.querySelector(".favorite-icon").getAttribute("data-postNo");


        fetch(`/selectpost/${postNo}/comment`, {
            method: "POST",
            body: new URLSearchParams({
                commentContent: commentContent,

            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (Array.isArray(data.comments)) {
                        addCommentToDOM(data.comments);  // 댓글 목록을 DOM에 추가
                    } else {
                        console.error("댓글 목록이 배열이 아닙니다:", data.comments);
                    }
                    commentInput.value = "";
                } else {
                    alert(data.error || "댓글 작성에 실패했습니다.");
                }
            })
            .catch(error => console.error("Error:", error));
    }

    function deleteComment(commentNo) {
        const postNo = document.querySelector(".favorite-icon").getAttribute("data-postNo");

        if (confirm("댓글을 삭제하시겠습니까?")) {
            fetch(`/selectpost/${postNo}/comment/${commentNo}/delete`, {
                method: "DELETE"
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("네트워크 응답이 실패했습니다.");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (Array.isArray(data.comments)) {
                            addCommentToDOM(data.comments);  // 최신 댓글 목록으로 갱신
                        } else {
                            console.error("댓글 목록이 배열이 아닙니다:", data.comments);
                        }
                    } else {
                        alert(data.error || "댓글 삭제에 실패했습니다.");
                    }
                })
                .catch(error => console.error("Error:", error));
        }
    }
    // 댓글 수정 함수
    function editComment(commentNo) {
        // 수정할 댓글의 내용을 가져옴
        const commentDiv = document.querySelector(`.comment [data-comment-no="${commentNo}"]`).parentElement;
        const currentContent = commentDiv.querySelector("span:nth-child(4)").textContent;

        // 댓글 수정 창을 띄우기 위해 prompt를 사용
        const newContent = prompt("댓글을 수정하세요:", currentContent);

        if (newContent && newContent !== currentContent) {
            const postNo = document.querySelector(".favorite-icon").getAttribute("data-postNo");

            // 서버에 수정된 댓글 전송
            fetch(`/selectpost/${postNo}/comment/${commentNo}/edit`, {
                method: "PUT",
                body: new URLSearchParams({
                    commentContent: newContent,
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (Array.isArray(data.comments)) {
                            addCommentToDOM(data.comments);  // 최신 댓글 목록으로 갱신
                        } else {
                            console.error("댓글 목록이 배열이 아닙니다:", data.comments);
                        }
                    } else {
                        alert(data.error || "댓글 수정에 실패했습니다.");
                    }
                })
                .catch(error => console.error("Error:", error));
        }
    }
    // 이벤트 위임을 통해 삭제 버튼의 클릭 이벤트 처리
    document.getElementById("comments-list").addEventListener("click", function (event) {
        if (event.target.classList.contains("delete-comment-btn")) {
            const commentNo = event.target.getAttribute("data-comment-no");
            deleteComment(commentNo);
        } else if (event.target.classList.contains("edit-comment-btn")) {
            const commentNo = event.target.getAttribute("data-comment-no");
            editComment(commentNo);
        }
    });

    // 댓글 더보기 버튼 클릭 시 댓글 목록을 로드하거나 숨기는 함수
    function loadComments() {
        const commentsList = document.getElementById("comments-list");
        const showMoreButton = document.querySelector(".show-more-comments span");

        // 댓글 목록이 보이지 않으면 댓글을 로드하고, 보이면 숨깁니다.
        if (commentsList.style.display === "none") {
            commentsList.style.display = "block";  // 댓글 목록을 보이게 함
            showMoreButton.textContent = "댓글 숨기기";  // 버튼 텍스트 변경

            // 댓글들을 순차적으로 처리
            const commentDivs = commentsList.querySelectorAll(".comment");
            commentDivs.forEach((commentDiv, index) => {
                // 댓글의 위치를 조정
                commentDiv.style.position = "relative";
                commentDiv.style.top = `${index * 200}px`;  // 댓글 간 간격을 150px로 설정
            });

        } else {
            commentsList.style.display = "none";  // 댓글 목록을 숨김
            showMoreButton.textContent = "댓글 보기";  // 버튼 텍스트 변경
        }
    }

    // userNo를 JavaScript 변수에 할당
    const loggedInUserNo = [[${userNo}]] ;  // ${userNo} 값이 없을 경우 0으로 기본값 설정
    console.log("Logged In UserNo:", loggedInUserNo);  // 로그인한 사용자의 userNo 확인
    // addCommentToDOM을 외부로 이동
    function addCommentToDOM(comments) {
        const commentsList = document.getElementById("comments-list");
        commentsList.innerHTML = ""; // 기존 댓글 목록을 제거하고 새로운 목록을 추가

        // comments가 배열인 경우만 처리
        if (Array.isArray(comments)) {
            comments.forEach((comment,index) => {
                const commentDiv = document.createElement("div");
                commentDiv.classList.add("comment")

                commentDiv.style.position = "relative";
                commentDiv.style.top = `${index * 200}px`;  // 댓글 간 간격 조절



                 // 댓글 간 간격 조절

                // 댓글 내용 추가
                commentDiv.innerHTML = `
                <img src="/images/post/selectpost/profile-img.png" alt="Profile Image">
                <span>${comment.username}</span>
                <span>${comment.userLevel}</span>
                <span>${comment.commentContent}</span>
                <span>${comment.commentDate}</span>
                <img src="/images/post/selectpost/like-btn-before.png" alt="Like Button">
                <span>좋아요</span>



            `;


                // 콘솔에 userNo와 비교 결과 출력
                console.log("comment.userNo:", comment.userNo);  // 댓글 작성자 userNo 확인
                console.log("loggedInUserNo:", loggedInUserNo);  // 로그인 사용자 userNo 확인
                console.log("Comparison result:", Number(comment.userNo) === Number(loggedInUserNo));  // 비교 결과 확인


                // 로그인한 사용자와 댓글 작성자가 같을 때만 삭제 버튼을 보이게 함
                if (Number(comment.userNo) === Number(loggedInUserNo)) {
                    const deleteButton = document.createElement("button");
                    deleteButton.classList.add("delete-comment-btn");
                    deleteButton.textContent = "삭제";
                    deleteButton.setAttribute("data-comment-no", comment.commentNo);
                    commentDiv.appendChild(deleteButton); // 삭제 버튼을 댓글에 추가

                    const editButton = document.createElement("button");
                    editButton.classList.add("edit-comment-btn");
                    editButton.textContent = "수정";
                    editButton.setAttribute("data-comment-no", comment.commentNo);
                    commentDiv.appendChild(editButton); // 수정 버튼을 댓글에 추가
                }else {
                    // 로그인한 사용자와 댓글 작성자가 다를 때 신고 버튼 추가
                    const reportDiv = document.createElement("div");

                    reportDiv.innerHTML = `
                    <img src="/images/post/selectpost/reportbtn.png" alt="Report Button">
                    <span>신고</span>
                `;

                    commentDiv.appendChild(reportDiv);
                }

                commentsList.appendChild(commentDiv);
            });

        } else {
            console.error("댓글 목록을 표시할 수 없습니다. comments 배열이 아닙니다.", comments);
        }
    }







</script>
<script>
    function toggleFavorite(element) {
        const postNo = element.getAttribute('data-postNo');
        const isFavorite = element.getAttribute('src').includes('best-dark.png');
        fetch(`/togglefavorite`, {
            method: 'POST', headers: {
                'Content-Type': 'application/json'
            }, body: JSON.stringify({ postNo: postNo, isFavorite: !isFavorite }) })
            .then(response => response.json()) .then(data => { if (data.success) {
            element.src = isFavorite ? '/images/post/best-none-dark.png' : '/images/post/best-dark.png';
        } }) }
</script>


<script>
    function toggleScary(element) {
        const postNo = element.getAttribute('data-postNo');
        const isScary = element.getAttribute('src').includes('scary-btn-after.png');

        fetch(`/togglescary`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ postNo: postNo, isScary: !isScary })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    element.src = isScary ? '/images/post/selectpost/scary-btn-before.png' : '/images/post/selectpost/scary-btn-after.png';
                    document.querySelector('#scary>span').textContent = data.scaryNumber;
                }
            })
    }

    function toggleNotScary(element) {
        const postNo = element.getAttribute('data-postNo');
        const isNotScary = element.getAttribute('src').includes('not-scary-btn-after.png');

        fetch(`/togglenotscary`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ postNo: postNo, isNotScary: !isNotScary })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    element.src = isNotScary ? '/images/post/selectpost/not-scary-btn-before.png' : '/images/post/selectpost/not-scary-btn-after.png';
                    document.querySelector('#notscary>span').textContent = data.notScaryNumber;
                }
            })
    }

</script>

<script>
    window.addEventListener('load', () => {
        const box = document.getElementById('box');
        const footer = document.querySelector('footer .footer');

        const boxHeight = box.offsetHeight;
        const boxTop = box.offsetTop;
        const footerTop = boxTop + boxHeight + 50; // 박스와의 간격을 50px로 설정

        const img = document.getElementById('img2');
        const imgBottom = img.getBoundingClientRect().bottom;
        const contentBottom = content.getBoundingClientRect().bottom;
        const minTop = imgBottom + 10;
        const defaultTop1 = 250;
        const defaultTop2 = 150;
        if (contentBottom<1480){
            box.style.top = `${Math.max(minTop, defaultTop1)}px`;

        }

        if (contentBottom>1480){
            box.style.top = `${Math.min(minTop, defaultTop2)}px`;
        }

        setTimeout(() => {
            const boxTop = box.getBoundingClientRect().top + window.scrollY;
            const footerTop = boxTop + box.scrollHeight + 10;
            footer.style.position = 'absolute';
            footer.style.top = `${footerTop}px`;
        }, 100);
    });



</script>
</body>
</html>