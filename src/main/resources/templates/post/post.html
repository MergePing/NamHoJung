<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>게시판</title>
    <link rel="stylesheet" th:href="@{/css/reset.css}">
    <link rel="stylesheet" th:href="@{/css/post/post.css}">
    <style>
        .post {
            position: relative;
        }
        .dn{
            display: none;
        }
    </style>
</head>
<body>
<header>
    <nav>
        <!--네비바-->
        <img th:src="@{/images/notice/nav-logo-dark.png}" alt="상단 로고" onclick="window.location.href='/'">
        <span onclick="location.href='/intro'">소개</span>
        <span onclick="location.href='/notice'">공지사항</span>
        <span onclick="location.href='/post'">게시판</span>
        <span>MBTI 검사</span>
        <span>마이페이지</span>
        <span>로그인</span>
        <span>회원가입</span>
    </nav>
</header>

<main>
    <div class="qickBtn">
        <!--플로팅 버튼-->
        <img th:src="@{/images/notice/folating-btn-dark.png}" id="light" class="tr" alt="플로팅 버튼">
        <img th:src="@{/images/notice/folating-btn-click-dark.png}" class="dn tr" id="dark" alt="플로팅 버튼 클릭">
        <div class="clikbtn tr">
            <img th:src="@{/images/notice/top-btn-dark.png}" class="dn" id="top" alt="탑버튼">
            <img th:src="@{/images/notice/light-btn-dark.png}" class="dn" id="mode" alt="테마 변경">
            <img th:src="@{/images/notice/test-btn-dark.png}" class="dn" id="test" alt="MBTI 테스트">
        </div>
    </div>

    <img th:src="@{/images/post/post-bg-dark.png}" id="bg">

    <div class="write" onclick="location.href='/newpost'">
        <p >게시글 작성</p>
    </div>

    <div class="select">
        <button>분류</button>
    </div>
    <div class="modal dn">
        <div class="modalContent">
            <button id="modalSelect">분류</button>
            <div id="category">
                <button id="modalCategory">카테고리</button>
                <div class="categoryBox dn">
                    <button id="real">실화</button>
                    <button id="mystery">미스테리</button>
                    <button id="sf">SF</button>
                    <button id="thrill">스릴러</button>
                    <button id="ghost">괴담</button>
                </div>
            </div>
            <button id="modalComment">댓글순</button>
            <button id="modalScary">인기순</button>
            <button id="modalNew">작성순</button>
            <button id="modalFavorite">즐겨찾기</button>
        </div>
    </div>
<!--    카테고리 분류-->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.querySelector(".modal");
            const modalBtn = document.querySelector(".select button");
            const select = document.getElementById("modalSelect");
            const category = document.getElementById("modalCategory");
            const categoryBox = document.querySelector(".categoryBox");
            const real = document.getElementById("real");
            const mystery = document.getElementById("mystery");
            const sf = document.getElementById("sf");
            const thrill = document.getElementById("thrill");
            const ghost = document.getElementById("ghost");
            const comment = document.getElementById("modalComment");
            const scary = document.getElementById("modalScary");
            const New = document.getElementById("modalNew");
            const favorite = document.getElementById("modalFavorite");

            function updatePosts(orderBy, category) {
                let url = `/post/sort?orderBy=${encodeURIComponent(orderBy)}`;
                if (category) {
                    url += `&category=${encodeURIComponent(category)}`;
                }
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched data:', data); // 데이터 확인을 위한 콘솔 로그
                        renderPosts(data.postList);
                    })
                    .catch(error => console.error('Error fetching posts:', error));
            }

            modalBtn.addEventListener('click', () => {
                modal.classList.toggle("dn");
            });
            select.addEventListener('click', () => {
                modal.classList.toggle("dn");
            });

            category.addEventListener('click', () => {
                categoryBox.classList.toggle("dn");
                modalBtn.innerText = "카테고리";
                select.innerText = "카테고리";
                toggleCategoryButtons();
                select.addEventListener('click',()=>{
                    select.innerText="분류";
                    toggleCategoryButtons()
                    categoryBox.classList.toggle("dn")

                })
            });

            function toggleCategoryButtons() {
                comment.classList.toggle("dn");
                scary.classList.toggle("dn");
                New.classList.toggle("dn");
                favorite.classList.toggle("dn");
                category.classList.toggle("dn");
            }

            comment.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "댓글순";
                updatePosts("COMMENTS_NUMBER", null);
            });

            scary.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "인기순";
                updatePosts("SCARY_NUMBER", null);
            });

            New.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "작성순";
                updatePosts("POST_DATE", null);
            });

            favorite.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "즐겨찾기순";
                updatePosts("POST_FAVORITE", null);
            });

            real.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "실화";
                updatePosts("POST_NO", "실화");
            });

            mystery.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "미스테리";
                updatePosts("POST_NO", "미스테리");
            });

            sf.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "SF";
                updatePosts("POST_NO", "SF");
            });

            thrill.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "스릴러";
                updatePosts("POST_NO", "스릴러");
            });

            ghost.addEventListener('click', () => {
                modal.classList.toggle("dn");
                modalBtn.innerText = "괴담";

                updatePosts("POST_NO", "괴담");
            });

            function renderPosts(posts) {
                const postContainer = document.getElementById('postContainer');
                postContainer.innerHTML = '';
                posts.forEach((post, index) => addNewPost(post, index));

                    function addNewPost(post, index) {
                        const postContainer = document.getElementById('postContainer');
                        const newPost = document.createElement('div');
                        newPost.classList.add('post');
                        newPost.setAttribute('style', `top: ${index * 80}px`);
                        newPost.innerHTML = `
            <span>${post.postNo}</span>
            <span>
                <img src="/images/post/best-${post.postFavorite ? 'dark' : 'none-dark'}.png"
                     data-postNo="${post.postNo}" class="favorite-icon" onclick="toggleFavorite(this)">
            </span>
            <a href="/selectpost/${post.postNo}">
                <span>${post.postTitle}</span>
            </a>
            <div><span>${post.postCategory}</span></div>
            <span>${post.postDate}</span>
            <span>${post.scaryNumber}</span>
            <span>${post.commentNumber}</span>
        `;
                        postContainer.appendChild(newPost);
                    }
            }
            // 초기 데이터 렌더링
            updatePosts("POST_NO", null)
        });
    </script>
    <input type="search" id="searchInput" placeholder="&nbsp; &nbsp; &nbsp;검색어를 입력하세요">
    <label><img th:src="@{/images/post/Search-dark.png}" id="searchBtn"></label>


    <div class="sell">
        <span>번호</span>
        <span>즐겨찾기</span>
        <span>게시물 제목</span>
        <span>카테고리</span>
        <span>등록날짜</span>
        <span>무서워요</span>
        <span>댓글</span>
    </div>
    <div class="post1" id="postContainer">
        <div class="post" th:each="post, iterStat : ${postList}" th:attr="style=${'top: ' + (iterStat.index * 80) + 'px;'}">
            <span th:text="${post.postNo}" id="postNo"></span>
            <span>
            <img th:src="@{/images/post/best-dark.png}" th:if="${post.postFavorite}"
                 th:attr="data-postNo=${post.postNo}" class="favorite-icon" onclick="toggleFavorite(this)">
            <img th:src="@{/images/post/best-none-dark.png}" th:unless="${post.postFavorite}"
                 th:attr="data-postNo=${post.postNo}" class="favorite-icon" onclick="toggleFavorite(this)">
            </span>
            <a th:src="@{/selectpost/{postNo}(postNo=${post.postNo})}">
                <span th:text="${post.postTitle}"></span>
            </a>
            <div><span th:text="${post.postCategory}"></span></div>
            <span th:text="${post.postDate}"></span>
            <span th:text="${post.scaryNumber}"></span>
            <span th:text="${post.commentNumber}"></span>
        </div>
    </div>

    <div class="pageNum">
        <img th:src="@{/images/notice/pre-btn.png}" id="img1">
        <div class="tab" id="tabContainer">
        </div>
        <img th:src="@{/images/notice/next-btn.png}" id="img2">
    </div>
</main>

<footer>
    <div class="footer"><p>ⓒ 2024 MergePing. All right reserved.  </p></div>
</footer>

</body>

<!--즐겨찾기-->
<script>
    function toggleFavorite(element) {
        const postNo = element.getAttribute('data-postNo');
        const isFavorite = element.getAttribute('src').includes('best-dark.png');
        fetch(`/toggleFavorite`, {
            method: 'POST', headers: {
                'Content-Type': 'application/json'
            }, body: JSON.stringify({ postNo: postNo, isFavorite: !isFavorite }) })
            .then(response => response.json()) .then(data => { if (data.success) {
            element.src = isFavorite ? '/images/post/best-none-dark.png' : '/images/post/best-dark.png';
        } }) .catch(error => console.error('Error:', error)); }
</script>

<!--검색-->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchBtn = document.getElementById('searchBtn');
        searchBtn.addEventListener('click', function() {
            const keyword = String(document.getElementById('searchInput').value);
            fetchPosts(keyword);
        });

        function fetchPosts(keyword) {
            fetch(`/searchpost?keyword=${encodeURIComponent(keyword)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const postContainer = document.getElementById('postContainer');
                    postContainer.innerHTML = '';

                    if (data && data.posts && Array.isArray(data.posts)) {
                        const posts = data.posts;

                        if (posts.length === 0) {
                            const noResultsMessage = document.createElement('p');
                            noResultsMessage.textContent = '검색 결과가 없습니다.';
                            postContainer.appendChild(noResultsMessage);
                        } else {
                            posts.forEach((post, index) => {
                                if (post !== null) {
                                    addNewPost(post, index);
                                }
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching posts:', error);
                });
        }

        function addNewPost(post, index) {
            const postContainer = document.getElementById('postContainer');
            const newPost = document.createElement('div');
            newPost.classList.add('post');
            newPost.setAttribute('style', `top: ${index * 80}px`);
            newPost.innerHTML = `
            <span>${post.postNo}</span>
            <span>
                <img src="/images/post/best-${post.postFavorite ? 'dark' : 'none-dark'}.png"
                     data-postNo="${post.postNo}" class="favorite-icon" onclick="toggleFavorite(this)">
            </span>
            <a href="/selectpost/${post.postNo}">
                <span>${post.postTitle}</span>
            </a>
            <div><span>${post.postCategory}</span></div>
            <span>${post.postDate}</span>
            <span>${post.scaryNumber}</span>
            <span>${post.commentNumber}</span>
        `;
            postContainer.appendChild(newPost);
        }
    });


</script>

<!--페이징-->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentPage = 1;
        const pageSize = 7;
        let totalPageCount = 0;
        let number =0
        let visibleStart =1;
        if (totalPageCount<=number){
            number =number+1;
        }

        function loadPosts(page) {
            if (page < 1 || (totalPageCount+1 > 0 && page > totalPageCount+(number+2))) return;
            currentPage = page;
            fetch(`/post/page?page=${page}&pageSize=${pageSize}`)
                .then(response => response.json())
                .then(posts => {
                    const postContainer = document.getElementById('postContainer');
                    postContainer.innerHTML = '';
                    posts.forEach((post, index) => addNewPost(post, index));
                    updateTabButtons();
                })

        }

        function addNewPost(post, index) {
            const postContainer = document.getElementById('postContainer');
            const newPost = document.createElement('div');
            newPost.classList.add('post');
            newPost.setAttribute('style', `top: ${index * 80}px`);
            newPost.innerHTML = `
            <span>${post.postNo}</span>
            <span>
                <img src="/images/post/best-${post.postFavorite ? 'dark' : 'none-dark'}.png"
                    data-postNo="${post.postNo}" class="favorite-icon" onclick="toggleFavorite(this)">
            </span>
            <a href="/selectpost/${post.postNo}">
                <span>${post.postTitle}</span>
            </a>
            <div><span>${post.postCategory}</span></div>
            <span>${post.postDate}</span>
            <span>${post.scaryNumber}</span>
            <span>${post.commentNumber}</span>
        `;
            postContainer.appendChild(newPost);
        }

        function updateTabButtons() {
            const tabContainer = document.getElementById('tabContainer');
            tabContainer.innerHTML = '';

            fetch('/post/page?page=1&pageSize=1')
                .then(response => response.json())
                .then(postList => {
                    const postCount = postList.length;
                    totalPageCount = Math.ceil(postCount / pageSize);

                    for (let i = number; i <= totalPageCount +(number+2); i++) {
                        const tab = document.createElement('p');
                        tab.id = `tab${i}`;
                        tab.textContent = `${i}`;
                        tab.addEventListener('click', () => loadPosts(i));
                        tab.style.color = i === currentPage ? '#fff' : '#BEBEBE';
                        tabContainer.appendChild(tab);
                    }
                    updateVisibility();
                })
        }

        function updateVisibility() {
            const tabs = document.querySelectorAll('.pageNum p');
            tabs.forEach(tab => tab.classList.remove('active', 'inactive', 'left-920', 'left-960'));

            for (let i = visibleStart; i < visibleStart + 2 && i <= totalPageCount + number + 2; i++) {
                if (i === visibleStart) {
                    tabs[i - 1].classList.add('inactive', 'left-920');
                } else if (i === visibleStart + 1) {
                    tabs[i - 1].classList.add('active', 'left-960');
                }
            }
        }


        document.getElementById('img1').addEventListener('click', () => {
            if (visibleStart > 1) {
                visibleStart--;
                updateVisibility();
            } if (currentPage > 1) {
                loadPosts(currentPage - 1);
            }

        });
        document.getElementById('img2').addEventListener('click', () => {
            if (visibleStart + 1 < totalPageCount+number+2) {
                visibleStart++;
                updateVisibility();
            }
            if (currentPage < totalPageCount+number+2) {
                loadPosts(currentPage + 1);
            }
        });
        loadPosts(1);
    });
</script>


<!--플로팅 버튼-->
<script>
    const floatBtn1 = document.getElementById("light");
    const floatBtn2 = document.getElementById("dark");
    const qickMenu1 =document.getElementById("top");
    const qickMenu2 =document.getElementById("mode");
    const qickMenu3 =document.getElementById("test");

    <!--플로팅 버튼 클릭시 퀵메뉴 display block-->
    floatBtn1.addEventListener('click',function (){
        floatBtn1.classList.toggle('dn');
        floatBtn2.classList.toggle('dn');
        qickMenu1.classList.toggle('dn');
        qickMenu2.classList.toggle('dn');
        qickMenu3.classList.toggle('dn');
    });


    <!--플로팅 버튼 클릭시 퀵메뉴 display none-->
    floatBtn2.addEventListener('click',function (){
        floatBtn1.classList.toggle('dn');
        floatBtn2.classList.toggle('dn');
        qickMenu1.classList.toggle('dn');
        qickMenu2.classList.toggle('dn');
        qickMenu3.classList.toggle('dn');

    });

    <!--top 버튼 클릭시 화면 상단이동-->
    setTimeout(function() {
        qickMenu1.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }, 3000);

</script>
</html>